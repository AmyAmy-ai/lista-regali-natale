<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <title>Lista Regali di Natale üéÑ</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --bg-gradient-start: #1c1b2b;
      --bg-gradient-end: #2b3b2f;
      --card-bg: rgba(255, 255, 255, 0.96);
      --card-border: rgba(255, 215, 128, 0.9);
      --accent: #c62828;
      --accent-soft: #f2c94c;
      --text-main: #222222;
      --text-muted: #666666;
      --chip-bg: rgba(255, 255, 255, 0.18);
      --chip-active-bg: #f7f0d9;
      --chip-border: rgba(255, 255, 255, 0.4);
      --shadow-soft: 0 10px 25px rgba(0, 0, 0, 0.25);
      --radius-lg: 18px;
      --radius-xl: 24px;
      --transition-fast: 0.18s ease-out;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      color: var(--text-main);
      min-height: 100vh;
      background: radial-gradient(circle at top, #3b2b3d 0, #1c1b2b 40%, #101019 80%);
      overflow-x: hidden;
    }

    #snow-canvas {
      position: fixed;
      inset: 0;
      z-index: 0;
      pointer-events: none;
    }

    .app {
      position: relative;
      z-index: 1;
      max-width: 680px;
      margin: 0 auto;
      padding: 12px 14px 32px;
    }

    header {
      text-align: center;
      color: #fefefe;
      margin-bottom: 14px;
    }

    header h1 {
      margin: 4px 0 4px;
      font-size: 1.4rem;
      letter-spacing: 0.03em;
    }

    header .subtitle {
      font-size: 0.9rem;
      opacity: 0.9;
      margin-bottom: 8px;
    }

    header .stats {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 4px 10px;
      font-size: 0.8rem;
      background: rgba(0, 0, 0, 0.25);
      border-radius: 999px;
      border: 1px solid rgba(255, 255, 255, 0.2);
      backdrop-filter: blur(6px);
    }

    header .stats span {
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }

    .badge-dot {
      width: 6px;
      height: 6px;
      border-radius: 999px;
      background: var(--accent-soft);
    }

    .controls {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      align-items: center;
      margin-bottom: 10px;
    }

    .primary-btn {
      flex: 1 1 180px;
      border: none;
      border-radius: 999px;
      padding: 10px 14px;
      font-size: 0.95rem;
      font-weight: 600;
      color: #fff;
      background: linear-gradient(135deg, #c62828, #f57c00);
      box-shadow: var(--shadow-soft);
      display: inline-flex;
      justify-content: center;
      align-items: center;
      gap: 6px;
      cursor: pointer;
      transition: transform var(--transition-fast), box-shadow var(--transition-fast), opacity var(--transition-fast);
    }

    .primary-btn span {
      font-size: 1.1rem;
    }

    .primary-btn:active {
      transform: translateY(1px) scale(0.99);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.35);
    }

    .secondary-btn {
      border-radius: 999px;
      border: 1px solid rgba(255, 255, 255, 0.6);
      padding: 8px 10px;
      font-size: 0.85rem;
      background: rgba(255, 255, 255, 0.08);
      color: #fff;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      cursor: pointer;
      transition: background var(--transition-fast), transform var(--transition-fast);
      white-space: nowrap;
    }

    .secondary-btn span {
      font-size: 1rem;
    }

    .secondary-btn.active {
      background: rgba(255, 255, 255, 0.16);
    }

    .secondary-btn:active {
      transform: translateY(1px);
    }

    .emoji-filters {
      width: 100%;
      overflow-x: auto;
      display: flex;
      gap: 6px;
      padding: 2px 0 4px;
      scrollbar-width: thin;
    }

    .chip {
      border-radius: 999px;
      border: 1px solid var(--chip-border);
      padding: 4px 10px;
      font-size: 0.8rem;
      background: var(--chip-bg);
      color: #fdfdfd;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      cursor: pointer;
      flex-shrink: 0;
      backdrop-filter: blur(4px);
      transition: background var(--transition-fast), transform var(--transition-fast), border-color var(--transition-fast);
    }

    .chip span {
      font-size: 1.1rem;
    }

    .chip.active {
      background: var(--chip-active-bg);
      color: #442312;
      border-color: rgba(210, 140, 70, 0.9);
      transform: translateY(-1px);
    }

    .chip:active {
      transform: translateY(1px);
    }

    .person-form-container {
      margin: 8px 0 14px;
      background: rgba(255, 255, 255, 0.98);
      border-radius: var(--radius-xl);
      border: 1px solid rgba(255, 215, 160, 0.9);
      padding: 10px 12px 10px;
      box-shadow: var(--shadow-soft);
      transform-origin: top center;
      transition: transform var(--transition-fast), opacity var(--transition-fast), max-height 0.25s ease-out;
      overflow: hidden;
    }

    .person-form-container.hidden {
      opacity: 0;
      transform: scaleY(0.8);
      max-height: 0;
      padding-top: 0;
      padding-bottom: 0;
      border-width: 0;
      box-shadow: none;
    }

    .person-form-container h2 {
      margin: 0 0 6px;
      font-size: 1rem;
      display: flex;
      align-items: center;
      gap: 6px;
      color: #6b3e1e;
    }

    .person-form-container h2 span {
      font-size: 1.2rem;
    }

    .form-row {
      display: flex;
      flex-direction: column;
      gap: 4px;
      margin-bottom: 8px;
    }

    .form-row label {
      font-size: 0.8rem;
      color: var(--text-muted);
    }

    .form-row input {
      border-radius: 999px;
      border: 1px solid #ddd0c0;
      padding: 8px 10px;
      font-size: 0.9rem;
      outline: none;
      transition: border-color var(--transition-fast), box-shadow var(--transition-fast);
    }

    .form-row input:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 2px rgba(198, 40, 40, 0.18);
    }

    .emoji-input-row {
      display: flex;
      align-items: center;
      gap: 8px;
      flex-wrap: wrap;
    }

    .emoji-input-row input {
      max-width: 100px;
      text-align: center;
      font-size: 1.1rem;
    }

    .form-actions {
      display: flex;
      justify-content: flex-end;
      gap: 6px;
      margin-top: 2px;
    }

    .btn-text {
      border-radius: 999px;
      border: none;
      padding: 6px 10px;
      font-size: 0.85rem;
      background: transparent;
      cursor: pointer;
      color: var(--text-muted);
    }

    .btn-primary {
      border-radius: 999px;
      border: none;
      padding: 7px 12px;
      font-size: 0.9rem;
      font-weight: 600;
      background: linear-gradient(135deg, #c62828, #f57c00);
      color: #fff;
      cursor: pointer;
      box-shadow: 0 6px 14px rgba(0, 0, 0, 0.2);
      transition: transform var(--transition-fast), box-shadow var(--transition-fast);
    }

    .btn-primary:active {
      transform: translateY(1px);
      box-shadow: 0 3px 7px rgba(0, 0, 0, 0.3);
    }

    .people-list {
      display: flex;
      flex-direction: column;
      gap: 10px;
      margin-top: 6px;
    }

    .empty-state {
      margin-top: 14px;
      text-align: center;
      color: rgba(255, 255, 255, 0.86);
      font-size: 0.9rem;
    }

    .empty-state span {
      font-size: 1.4rem;
      display: block;
      margin-bottom: 4px;
    }

    .person-card {
      background: var(--card-bg);
      border-radius: var(--radius-xl);
      border: 1px solid var(--card-border);
      box-shadow: var(--shadow-soft);
      padding: 8px 10px 2px;
      transition: transform var(--transition-fast), box-shadow var(--transition-fast), background var(--transition-fast);
      position: relative;
      overflow: hidden;
    }

    .person-card::before {
      content: "";
      position: absolute;
      inset: 0;
      background: linear-gradient(135deg, rgba(255, 215, 160, 0.16), transparent 40%, rgba(255, 255, 255, 0.18));
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.25s ease-out;
    }

    .person-card.expanded::before {
      opacity: 1;
    }

    .person-card:active {
      transform: translateY(1px) scale(0.997);
      box-shadow: 0 5px 12px rgba(0, 0, 0, 0.22);
    }

    .person-header-row {
      display: flex;
      align-items: flex-start;
      justify-content: space-between;
      gap: 6px;
    }

    .person-main {
      display: flex;
      flex-direction: column;
      flex: 1;
      min-width: 0;
      cursor: pointer;
    }

    .person-title-line {
      display: flex;
      align-items: baseline;
      gap: 4px;
      flex-wrap: nowrap;
      min-width: 0;
    }

    .person-emoji {
      font-size: 1.4rem;
      flex-shrink: 0;
    }

    .person-name {
      font-weight: 600;
      font-size: 0.98rem;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      max-width: 55%;
    }

    .person-preview {
      font-size: 0.82rem;
      color: var(--text-muted);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      flex: 1;
      min-width: 0;
    }

    .person-subtitle {
      font-size: 0.75rem;
      color: var(--text-muted);
      margin-top: 2px;
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .pill {
      border-radius: 999px;
      background: #f7efe2;
      padding: 1px 7px;
      font-size: 0.72rem;
      color: #7b4c28;
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }

    .person-actions {
      display: flex;
      flex-direction: column;
      gap: 4px;
      align-items: flex-end;
      flex-shrink: 0;
    }

    .icon-btn {
      border-radius: 999px;
      border: none;
      width: 26px;
      height: 26px;
      display: inline-flex;
      justify-content: center;
      align-items: center;
      cursor: pointer;
      background: transparent;
      font-size: 1rem;
      transition: background var(--transition-fast), transform var(--transition-fast);
    }

    .icon-btn.edit {
      background: #f3f0ff;
    }

    .icon-btn.delete {
      background: #ffe9e7;
    }

    .icon-btn:hover {
      transform: translateY(-1px);
    }

    .icon-btn:active {
      transform: translateY(1px) scale(0.97);
    }

    .person-details {
      margin-top: 6px;
      padding-top: 6px;
      border-top: 1px dashed rgba(0, 0, 0, 0.06);
      display: none;
    }

    .person-card.expanded .person-details {
      display: block;
    }

    .idea-list {
      list-style: none;
      margin: 0 0 6px;
      padding: 0;
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .idea-item {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 0.85rem;
      padding: 4px 6px;
      border-radius: 12px;
      background: #f9f5ef;
    }

    .status-badge {
      border-radius: 999px;
      border: none;
      padding: 2px 7px;
      font-size: 0.82rem;
      display: inline-flex;
      align-items: center;
      gap: 4px;
      cursor: pointer;
      background: #fff;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.12);
      transition: transform var(--transition-fast), box-shadow var(--transition-fast), background var(--transition-fast);
      flex-shrink: 0;
    }

    .status-badge span.icon {
      font-size: 1rem;
    }

    .status-badge span.label {
      font-size: 0.7rem;
      text-transform: uppercase;
      letter-spacing: 0.04em;
      color: #555;
    }

    .status-badge:active {
      transform: translateY(1px);
      box-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
    }

    .status-idea {
      background: #ffffff;
    }

    .status-bought {
      background: #e2f4e5;
    }

    .status-wrapped {
      background: #fff1da;
    }

    .idea-text {
      flex: 1;
      min-width: 0;
      word-break: break-word;
    }

    .add-idea-form {
      display: flex;
      align-items: center;
      gap: 6px;
      margin-top: 4px;
    }

    .add-idea-form input {
      flex: 1;
      border-radius: 999px;
      border: 1px solid #e0d1bf;
      padding: 6px 9px;
      font-size: 0.85rem;
    }

    .add-idea-form button {
      border-radius: 999px;
      border: none;
      padding: 6px 10px;
      font-size: 0.8rem;
      background: #f57c00;
      color: #fff;
      cursor: pointer;
      transition: transform var(--transition-fast), box-shadow var(--transition-fast);
      box-shadow: 0 3px 7px rgba(0, 0, 0, 0.25);
      white-space: nowrap;
    }

    .add-idea-form button:active {
      transform: translateY(1px);
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.35);
    }

    @media (min-width: 600px) {
      header h1 {
        font-size: 1.6rem;
      }
      .app {
        padding-top: 20px;
      }
      .person-card {
        padding: 10px 12px 4px;
      }
    }
@media (max-width: 900px) { 
img { 
   max-width: 100%;
   height: auto;
}

.table-container {
    overflow-x: auto;
    -webkit-overflow-scrolling: touch;
}

table {
    width: 100%;
    border-collapse: collapse;
}

td, th {
    padding: 8px;
    text-align: left;
    border: 1px solid #ddd;
}
}	


  </style>
</head>
<body>
  <canvas id="snow-canvas"></canvas>
  <div class="app">
    <header>
      <div class="subtitle">üéÅ Organizza i tuoi regali di Natale in un attimo</div>
      <h1>Lista Regali di Natale</h1>
      <div class="stats" id="stats">
        <span><span class="badge-dot"></span> 0 persone</span>
        <span>¬∑</span>
        <span>0 idee</span>
        <span>¬∑</span>
        <span>0 pronte üéÅ</span>
      </div>
    </header>

    <section class="controls">
      <button class="primary-btn" id="add-person-btn">
        <span>‚ûï</span>
        <span>Aggiungi persona</span>
      </button>
      <button class="secondary-btn" id="sort-toggle">
        <span>üî§</span>
        <span id="sort-label">Ordine: A-Z</span>
      </button>
      <div class="emoji-filters" id="emoji-filters">
        <!-- Chip generati via JS -->
      </div>
    </section>

    <section class="person-form-container hidden" id="person-form-container">
      <h2 id="person-form-title"><span>üßë‚ÄçüéÑ</span> Nuova persona</h2>
      <form id="person-form">
        <div class="form-row">
          <label for="person-emoji">Emoji (gruppo) ‚Äì scegli tu dal tastierino üòä</label>
          <div class="emoji-input-row">
            <input id="person-emoji" type="text" maxlength="4" value="üéÑ" />
          </div>
        </div>
        <div class="form-row">
          <label for="person-name">Nome</label>
          <input id="person-name" type="text" required placeholder="es. Mamma, Giulia, Collega Marco" />
        </div>
        <div class="form-row">
          <label for="person-first-idea">Prima idea regalo (opzionale)</label>
          <input id="person-first-idea" type="text" placeholder="es. Sciarpa di lana, libro, profumo..." />
        </div>
        <div class="form-actions">
          <button type="button" class="btn-text" id="cancel-person-btn">Annulla</button>
          <button type="submit" class="btn-primary">Salva</button>
        </div>
      </form>
    </section>

    <main class="people-list" id="people-list">
      <!-- Card generate via JS -->
    </main>
  </div>

  <script>
    (function () {
      const STORAGE_KEY = "christmasGiftListV1";

      let people = [];
      let activeEmojiFilter = null;
      let sortMode = "alpha"; // "alpha" | "emoji"
      let editPersonId = null;
      let expandedIds = new Set(); // mantiene aperte le card anche dopo il render

      const statsEl = document.getElementById("stats");
      const addPersonBtn = document.getElementById("add-person-btn");
      const sortToggleBtn = document.getElementById("sort-toggle");
      const sortLabelEl = document.getElementById("sort-label");
      const emojiFiltersEl = document.getElementById("emoji-filters");
      const personFormContainer = document.getElementById("person-form-container");
      const personFormTitle = document.getElementById("person-form-title");
      const personForm = document.getElementById("person-form");
      const personEmojiInput = document.getElementById("person-emoji");
      const personNameInput = document.getElementById("person-name");
      const personFirstIdeaInput = document.getElementById("person-first-idea");
      const cancelPersonBtn = document.getElementById("cancel-person-btn");
      const peopleListEl = document.getElementById("people-list");

      function loadPeople() {
        try {
          const raw = localStorage.getItem(STORAGE_KEY);
          if (!raw) return [];
          const parsed = JSON.parse(raw);
          if (!Array.isArray(parsed)) return [];
          return parsed;
        } catch (e) {
          console.error("Errore lettura localStorage", e);
          return [];
        }
      }

      function savePeople() {
        try {
          localStorage.setItem(STORAGE_KEY, JSON.stringify(people));
        } catch (e) {
          console.error("Errore salvataggio localStorage", e);
        }
      }

      function computeStats() {
        let totalPeople = people.length;
        let totalIdeas = 0;
        let readyIdeas = 0;
        people.forEach((p) => {
          totalIdeas += p.ideas.length;
          p.ideas.forEach((idea) => {
            if (idea.status === "bought" || idea.status === "wrapped") {
              readyIdeas++;
            }
          });
        });
        return { totalPeople, totalIdeas, readyIdeas };
      }

      function renderStats() {
        const { totalPeople, totalIdeas, readyIdeas } = computeStats();
        // usiamo solo gli span di primo livello per evitare di contare anche il pallino interno
        const spans = statsEl.children; // HTMLCollection dei figli diretti
        if (spans.length >= 5) {
          const peopleLabel = totalPeople === 1 ? " persona" : " persone";
          const ideasLabel = totalIdeas === 1 ? " idea totale" : " idee totali";
          const readyLabel = readyIdeas === 1 ? " pronta üéÅ" : " pronte üéÅ";

          spans[0].innerHTML = '<span class="badge-dot"></span> ' + totalPeople + peopleLabel;
          spans[2].textContent = totalIdeas + ideasLabel;
          spans[4].textContent = readyIdeas + readyLabel;
        }
      }

      function renderEmojiFilters() {
        emojiFiltersEl.innerHTML = "";
        const chipAll = document.createElement("button");
        chipAll.type = "button";
        chipAll.className = "chip" + (activeEmojiFilter === null ? " active" : "");
        chipAll.textContent = "Tutti";
        chipAll.addEventListener("click", () => {
          activeEmojiFilter = null;
          render();
        });
        emojiFiltersEl.appendChild(chipAll);

        const emojiSet = new Set();
        people.forEach((p) => {
          if (p.emoji && p.emoji.trim() !== "") {
            emojiSet.add(p.emoji.trim());
          }
        });

        Array.from(emojiSet)
          .sort((a, b) => a.localeCompare(b))
          .forEach((emoji) => {
            const chip = document.createElement("button");
            chip.type = "button";
            chip.className = "chip" + (activeEmojiFilter === emoji ? " active" : "");
            chip.innerHTML = "<span>" + emoji + "</span>";
            chip.addEventListener("click", () => {
              activeEmojiFilter = emoji === activeEmojiFilter ? null : emoji;
              render();
            });
            emojiFiltersEl.appendChild(chip);
          });
      }

      function getFilteredSortedPeople() {
        let arr = people.slice();
        if (activeEmojiFilter) {
          arr = arr.filter((p) => p.emoji === activeEmojiFilter);
        }
        if (sortMode === "alpha") {
          arr.sort((a, b) => a.name.toLowerCase().localeCompare(b.name.toLowerCase()));
        } else {
          arr.sort((a, b) => {
            const emojiCmp = (a.emoji || "").localeCompare(b.emoji || "");
            if (emojiCmp !== 0) return emojiCmp;
            return a.name.toLowerCase().localeCompare(b.name.toLowerCase());
          });
        }
        return arr;
      }

      function buildIdeasPreview(person) {
        if (!person.ideas || person.ideas.length === 0) {
          return " (nessuna idea ancora)";
        }
        const names = person.ideas.map((i) => i.text.trim()).filter(Boolean);
        if (names.length === 0) {
          return " (nessuna idea ancora)";
        }
        let joined = names.join(", ");
        const maxLen = 40;
        if (joined.length > maxLen) {
          joined = joined.slice(0, maxLen - 1).trimEnd() + "‚Ä¶";
        }
        return ": " + joined;
      }

      const STATUS_CYCLE = ["idea", "bought", "wrapped"];
      const STATUS_ICONS = {
        idea: "‚≠ï",
        bought: "‚úÖ",
        wrapped: "üéÅ",
      };
      const STATUS_LABELS = {
        idea: "idea",
        bought: "comprato",
        wrapped: "impacchettato",
      };

      function nextStatus(current) {
        const idx = STATUS_CYCLE.indexOf(current);
        if (idx === -1 || idx === STATUS_CYCLE.length - 1) {
          return STATUS_CYCLE[0];
        }
        return STATUS_CYCLE[idx + 1];
      }

      function getStatusClass(status) {
        if (status === "bought") return "status-bought";
        if (status === "wrapped") return "status-wrapped";
        return "status-idea";
      }

      function renderPeople() {
        peopleListEl.innerHTML = "";
        const arr = getFilteredSortedPeople();

        if (arr.length === 0) {
          const empty = document.createElement("div");
          empty.className = "empty-state";
          empty.innerHTML =
            "<span>‚ú®</span>Nessuna persona ancora.<br />Premi <strong>‚ÄúAggiungi persona‚Äù</strong> per iniziare la lista!";
          peopleListEl.appendChild(empty);
          return;
        }

        arr.forEach((person) => {
          const card = document.createElement("article");
          card.className = "person-card";
          card.dataset.id = person.id;
          if (expandedIds.has(person.id)) {
            card.classList.add("expanded");
          }

          const headerRow = document.createElement("div");
          headerRow.className = "person-header-row";

          const main = document.createElement("div");
          main.className = "person-main";

          const titleLine = document.createElement("div");
          titleLine.className = "person-title-line";

          const emojiSpan = document.createElement("span");
          emojiSpan.className = "person-emoji";
          emojiSpan.textContent = person.emoji || "üéÅ";

          const nameSpan = document.createElement("span");
          nameSpan.className = "person-name";
          nameSpan.textContent = person.name || "Senza nome";

          const previewSpan = document.createElement("span");
          previewSpan.className = "person-preview";
          previewSpan.textContent = buildIdeasPreview(person);

          titleLine.appendChild(emojiSpan);
          titleLine.appendChild(nameSpan);
          titleLine.appendChild(previewSpan);

          const subtitle = document.createElement("div");
          subtitle.className = "person-subtitle";

          const ideasCount = document.createElement("span");
          ideasCount.className = "pill";
          const count = person.ideas.length;
          ideasCount.innerHTML = "üéÅ " + count + (count === 1 ? " idea" : " idee");

          subtitle.appendChild(ideasCount);

          main.appendChild(titleLine);
          main.appendChild(subtitle);

          main.addEventListener("click", () => {
            const isExpanded = expandedIds.has(person.id);
            if (isExpanded) {
              expandedIds.delete(person.id);
              card.classList.remove("expanded");
            } else {
              expandedIds.add(person.id);
              card.classList.add("expanded");
            }
          });

          const actions = document.createElement("div");
          actions.className = "person-actions";

          const editBtn = document.createElement("button");
          editBtn.type = "button";
          editBtn.className = "icon-btn edit";
          editBtn.title = "Modifica persona";
          editBtn.textContent = "‚úèÔ∏è";
          editBtn.addEventListener("click", (e) => {
            e.stopPropagation();
            startEditPerson(person.id);
          });

          const deleteBtn = document.createElement("button");
          deleteBtn.type = "button";
          deleteBtn.className = "icon-btn delete";
          deleteBtn.title = "Elimina persona";
          deleteBtn.textContent = "üóëÔ∏è";
          deleteBtn.addEventListener("click", (e) => {
            e.stopPropagation();
            deletePerson(person.id);
          });

          actions.appendChild(editBtn);
          actions.appendChild(deleteBtn);

          headerRow.appendChild(main);
          headerRow.appendChild(actions);

          const details = document.createElement("div");
          details.className = "person-details";

          const ideaList = document.createElement("ul");
          ideaList.className = "idea-list";

          person.ideas.forEach((idea, index) => {
            const li = document.createElement("li");
            li.className = "idea-item";

            const statusBtn = document.createElement("button");
            statusBtn.type = "button";
            statusBtn.className =
              "status-badge " + getStatusClass(idea.status || "idea");
            statusBtn.innerHTML =
              '<span class="icon">' +
              (STATUS_ICONS[idea.status || "idea"] || "‚≠ï") +
              '</span><span class="label">' +
              (STATUS_LABELS[idea.status || "idea"] || "idea") +
              "</span>";
            statusBtn.addEventListener("click", (e) => {
              e.stopPropagation();
              cycleIdeaStatus(person.id, index);
            });

            const textSpan = document.createElement("span");
            textSpan.className = "idea-text";
            textSpan.textContent = idea.text;

            const deleteIdeaBtn = document.createElement("button");
            deleteIdeaBtn.type = "button";
            deleteIdeaBtn.className = "icon-btn delete";
            deleteIdeaBtn.title = "Elimina idea";
            deleteIdeaBtn.textContent = "‚úñ";
            deleteIdeaBtn.style.fontSize = "0.8rem";
            deleteIdeaBtn.addEventListener("click", (e) => {
              e.stopPropagation();
              deleteIdea(person.id, index);
            });

            li.appendChild(statusBtn);
            li.appendChild(textSpan);
            li.appendChild(deleteIdeaBtn);

            ideaList.appendChild(li);
          });

          const addIdeaForm = document.createElement("form");
          addIdeaForm.className = "add-idea-form";
          addIdeaForm.innerHTML =
            '<input type="text" placeholder="Aggiungi idea regalo..." />' +
            '<button type="submit">+ Idea</button>';
          addIdeaForm.addEventListener("submit", (e) => {
            e.preventDefault();
            e.stopPropagation();
            const input = addIdeaForm.querySelector("input");
            const text = input.value.trim();
            if (!text) return;
            addIdeaToPerson(person.id, text);
            input.value = "";
          });

          details.appendChild(ideaList);
          details.appendChild(addIdeaForm);

          card.appendChild(headerRow);
          card.appendChild(details);

          peopleListEl.appendChild(card);
        });
      }

      function render() {
        renderStats();
        renderEmojiFilters();
        renderPeople();
      }

      function showPersonForm(mode) {
        if (mode === "add") {
          editPersonId = null;
          personFormTitle.innerHTML = '<span>üßë‚ÄçüéÑ</span> Nuova persona';
          // esempio iniziale: albero di Natale, che sparisce al primo click
          personEmojiInput.value = "üéÑ";
          personEmojiInput.dataset.example = "true";
          personNameInput.value = "";
          personFirstIdeaInput.value = "";
        } else if (mode === "edit") {
          personFormTitle.innerHTML = '<span>‚úèÔ∏è</span> Modifica persona';
          delete personEmojiInput.dataset.example;
        }
        personFormContainer.classList.remove("hidden");
        setTimeout(() => {
          personNameInput.focus();
        }, 0);
      }

      function hidePersonForm() {
        personFormContainer.classList.add("hidden");
        editPersonId = null;
        personForm.reset();
        personEmojiInput.value = "";
      }

      function startAddPerson() {
        showPersonForm("add");
      }

      function startEditPerson(id) {
        const person = people.find((p) => p.id === id);
        if (!person) return;
        editPersonId = id;
        personEmojiInput.value = person.emoji || "";
        personNameInput.value = person.name || "";
        personFirstIdeaInput.value = "";
        showPersonForm("edit");
        window.scrollTo({ top: 0, behavior: "smooth" });
      }

      function addOrUpdatePersonFromForm(e) {
        e.preventDefault();
        const emoji = (personEmojiInput.value || "").trim() || "üéÅ";
        const name = (personNameInput.value || "").trim();
        const firstIdea = (personFirstIdeaInput.value || "").trim();

        if (!name) {
          alert("Inserisci almeno il nome della persona.");
          return;
        }

        if (editPersonId) {
          const person = people.find((p) => p.id === editPersonId);
          if (person) {
            person.emoji = emoji;
            person.name = name;
            if (firstIdea) {
              person.ideas.push({
                text: firstIdea,
                status: "idea",
              });
            }
          }
        } else {
          const newPerson = {
            id: "p-" + Date.now() + "-" + Math.floor(Math.random() * 100000),
            emoji,
            name,
            ideas: [],
          };
          if (firstIdea) {
            newPerson.ideas.push({
              text: firstIdea,
              status: "idea",
            });
          }
          people.push(newPerson);
        }

        savePeople();
        hidePersonForm();
        render();
      }

      function deletePerson(id) {
        // Eliminazione diretta, senza popup di conferma per evitare problemi sui mobile
        people = people.filter((p) => p.id !== id);
        expandedIds.delete(id);
        savePeople();
        render();
      }

      function addIdeaToPerson(id, text) {
        const person = people.find((p) => p.id === id);
        if (!person) return;
        person.ideas.push({
          text,
          status: "idea",
        });
        savePeople();
        render();
      }

      function deleteIdea(personId, ideaIndex) {
        const person = people.find((p) => p.id === personId);
        if (!person) return;
        person.ideas.splice(ideaIndex, 1);
        savePeople();
        render();
      }

      function cycleIdeaStatus(personId, ideaIndex) {
        const person = people.find((p) => p.id === personId);
        if (!person) return;
        const idea = person.ideas[ideaIndex];
        if (!idea) return;
        idea.status = nextStatus(idea.status || "idea");
        savePeople();
        render(); // la card resta aperta grazie a expandedIds
      }

      function toggleSortMode() {
        sortMode = sortMode === "alpha" ? "emoji" : "alpha";
        sortLabelEl.textContent = sortMode === "alpha" ? "Ordine: A-Z" : "Ordine: Emoji";
        render();
      }

      addPersonBtn.addEventListener("click", startAddPerson);
      sortToggleBtn.addEventListener("click", toggleSortMode);
      cancelPersonBtn.addEventListener("click", hidePersonForm);

      // Quando clicchi sul campo emoji per la prima volta, l'esempio (üéÑ) sparisce
      personEmojiInput.addEventListener("focus", () => {
        if (personEmojiInput.dataset.example === "true") {
          personEmojiInput.value = "";
          delete personEmojiInput.dataset.example;
        }
      });

      personForm.addEventListener("submit", addOrUpdatePersonFromForm);

      people = loadPeople();
      render();

      const canvas = document.getElementById("snow-canvas");
      const ctx = canvas.getContext("2d");
      let flakes = [];
      let width = window.innerWidth;
      let height = window.innerHeight;

      function resizeCanvas() {
        width = window.innerWidth;
        height = window.innerHeight;
        canvas.width = width;
        canvas.height = height;
      }

      function createFlakes() {
        const count = 80;
        flakes = [];
        for (let i = 0; i < count; i++) {
          flakes.push({
            x: Math.random() * width,
            y: Math.random() * height,
            r: 1 + Math.random() * 2.5,
            d: 0.5 + Math.random() * 0.9,
            drift: (Math.random() - 0.5) * 0.6,
          });
        }
      }

      function drawSnow() {
        ctx.clearRect(0, 0, width, height);
        ctx.fillStyle = "rgba(255, 255, 255, 0.85)";
        ctx.beginPath();
        flakes.forEach((f) => {
          ctx.moveTo(f.x, f.y);
          ctx.arc(f.x, f.y, f.r, 0, Math.PI * 2);
        });
        ctx.fill();
        updateSnow();
        requestAnimationFrame(drawSnow);
      }

      function updateSnow() {
        flakes.forEach((f) => {
          f.y += f.d;
          f.x += f.drift;
          if (f.y > height) {
            f.y = -5;
            f.x = Math.random() * width;
          }
          if (f.x < -5) f.x = width + 5;
          if (f.x > width + 5) f.x = -5;
        });
      }

      window.addEventListener("resize", () => {
        resizeCanvas();
        createFlakes();
      });

      resizeCanvas();
      createFlakes();
      requestAnimationFrame(drawSnow);
    })();
  </script>
<script defer src="https://static.cloudflareinsights.com/beacon.min.js/vcd15cbe7772f49c399c6a5babf22c1241717689176015" integrity="sha512-ZpsOmlRQV6y907TI0dKBHq9Md29nnaEIPlkf84rnaERnq6zvWvPUqr2ft8M1aS28oN72PdrCzSjY4U6VaAw1EQ==" data-cf-beacon='{"version":"2024.11.0","token":"4581d6a58cf94e929fad52deda295622","r":1,"server_timing":{"name":{"cfCacheStatus":true,"cfEdge":true,"cfExtPri":true,"cfL4":true,"cfOrigin":true,"cfSpeedBrain":true},"location_startswith":null}}' crossorigin="anonymous"></script>
</body>
</html>

